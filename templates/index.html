<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WebSocket Chat</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .chat-container {
            height: 70vh;
            overflow-y: auto;
        }
        .message {
            border-radius: 10px;
            padding: 8px 12px;
            margin-bottom: 8px;
            max-width: 70%;
        }
        .message-in {
            background-color: #e9ecef;
            align-self: flex-start;
        }
        .message-out {
            background-color: #0d6efd;
            color: white;
            align-self: flex-end;
        }
        .notification {
            background-color: #f8f9fa;
            border-left: 4px solid;
            padding: 6px 12px;
            margin: 8px 0;
            font-size: 0.9em;
        }
        #nameModal {
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0">WebSocket Chat</h3>
            </div>
            <div class="card-body p-0">
                <div id="chat" class="chat-container p-3 d-flex flex-column"></div>
                <div class="p-3 border-top">
                    <div class="input-group">
                        <input type="text" id="messageInput" class="form-control" placeholder="Введите сообщение..." disabled>
                        <button id="sendButton" class="btn btn-primary" disabled>Отправить</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно для ввода имени -->
    <div class="modal fade" id="nameModal" tabindex="-1" aria-hidden="false" data-bs-backdrop="static">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Представьтесь</h5>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="userName" class="form-label">Ваше имя:</label>
                        <input type="text" class="form-control" id="userName" placeholder="Как вас зовут?">
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="confirmName" class="btn btn-primary">Продолжить</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap 5 JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Элементы интерфейса
        const chat = document.getElementById('chat');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const userNameInput = document.getElementById('userName');
        const confirmNameBtn = document.getElementById('confirmName');
        const nameModal = new bootstrap.Modal(document.getElementById('nameModal'));
        
        // Переменные состояния
        let clientId = localStorage.getItem('clientId');
        let userName = localStorage.getItem('userName');
        let ws = null;
        
        // Показываем модальное окно при загрузке
        nameModal.show();
        
        // Обработчик подтверждения имени
        confirmNameBtn.addEventListener('click', () => {
            userName = userNameInput.value.trim();
            if (userName) {
                localStorage.setItem('userName', userName);
                connectWebSocket();
                nameModal.hide();
            } else {
                userNameInput.classList.add('is-invalid');
            }
        });
        
        // Подключение к WebSocket
        function connectWebSocket() {
            // Генерируем или получаем ID клиента
            if (!clientId) {
                fetch('/generate_id')
                    .then(response => response.json())
                    .then(data => {
                        clientId = data.client_id;
                        localStorage.setItem('clientId', clientId);
                        initializeWebSocket();
                    });
            } else {
                initializeWebSocket();
            }
        }
        
        function initializeWebSocket() {
            ws = new WebSocket(`ws://${window.location.host}/ws/${clientId}`);
            
            ws.onopen = () => {
                messageInput.disabled = false;
                sendButton.disabled = false;
                addNotification('Вы подключены к чату', 'primary');
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                
                if (data.type === 'request_name') {
                    ws.send(JSON.stringify({
                        type: "set_name",
                        name: userName
                    }));
                } 
                else if (data.type === 'message') {
                    addMessage(data.sender, data.message, data.sender_id === clientId);
                }
                else if (data.type === 'notification') {
                    addNotification(data.message, data.color);
                }
            };
            
            ws.onclose = () => {
                addNotification('Соединение закрыто', 'danger');
                messageInput.disabled = true;
                sendButton.disabled = true;
            };
        }
        
        // Отправка сообщения
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendMessage();
        });
        
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws) {
                const timestamp = new Date().toLocaleTimeString();
                ws.send(JSON.stringify({
                    type: "message",
                    message: message,
                    timestamp: timestamp
                }));
                messageInput.value = '';
            }
        }
        
        // Добавление сообщения в чат
        function addMessage(sender, text, isOutgoing = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOutgoing ? 'message-out' : 'message-in'}`;
            
            const senderSpan = document.createElement('span');
            senderSpan.className = 'fw-bold';
            senderSpan.textContent = sender + ': ';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            messageDiv.appendChild(senderSpan);
            messageDiv.appendChild(textSpan);
            
            chat.appendChild(messageDiv);
            chat.scrollTop = chat.scrollHeight;
        }
        
        // Добавление уведомления в чат
        function addNotification(text, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification border-${type}`;
            notification.textContent = text;
            chat.appendChild(notification);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>